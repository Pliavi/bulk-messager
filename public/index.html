<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>title</title>
    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.19.2",
          "preact/": "https://esm.sh/preact@10.19.2/",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact",
          "phoneNumbers": "./phoneNumbers.js"
        }
      }
    </script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="./style.css">
    <script type="module">
      import { render } from "preact";
      import { useReducer, useEffect, useState } from "preact/hooks";
      import { html } from "htm/preact";
      import { getFormattedNumbers } from "phoneNumbers";

      const NumberTag = ({ number, key }) => {
        return html`
          <div
            key=${key}
            class="flex bg-stone-200 px-4 py-2 rounded-lg max-w-[150px]"
          >
            <p>${number}</p>
          </div>
        `;
      };

      function BulkMessager({isReady}) {
        const [validatedNumbers, setValidatedNumbers] = useState();
        const [isEditing, setIsEditing] = useState(false);
        const [numbersString, setNumbersString] = useState("");
        const onValidateNumbers = () => {
          setIsEditing(false);
          const numbersArray = getFormattedNumbers(numbersString, "lineBreak");
          validatedNumbers && setNumbersString(validatedNumbers?.join("\n"));
          setValidatedNumbers(numbersArray.numbers);
        };

        return html`
          <div className="flex w-[800px] m-auto p-10 flex-col ${!isReady ? "hidden" : ""} items-start">
            <p className="text-large text-left font-semibold">
              Disparo de mensagens em massa
            </p>
            <p className="text-left">
              Insira as informações necessárias e clique em enviar mensagens
            </p>

            <p className="text-base mt-4 font-semibold">Destinatários</p>
            ${validatedNumbers && !isEditing
              ? html`
                  <div
                    className="border mt-2 border-zinc-400 rounded-md p-2 h-32 max-h-32 w-[720px] max-w-full relative"
                  >
                    <i
                      onClick=${() => setIsEditing(true)}
                      class="fas fa-edit absolute top-4 right-2 hover:cursor-pointer"
                    ></i>

                    ${validatedNumbers.map(
                      (number) => html`
                        <${NumberTag} key=${number} number=${number} />
                      `
                    )}
                  </div>
                `
              : html`
                  <textarea
                    onChange=${(e) => {
                      setNumbersString(e.target.value);
                    }}
                    value=${numbersString}
                    className="border mt-2 border-zinc-400 rounded-md p-2 h-32 max-h-32 w-[720px] max-w-full"
                    placeholder="Números de whats app para enviar sua mensagem"
                  />
                `}

            <button
              onClick=${onValidateNumbers}
              className="bg-green-500 hover:bg-greenDark text-white px-6 py-3 rounded-lg mt-4 font-semibold"
            >
              Validar números
            </button>
          </div>
        `;
      }

      export function App() {
        const [count, add] = useReducer((a, b) => a + b, 0);
        const [isReady, setIsReady] = useState(false);
        
        
        
        useEffect(() => {
          const qrDiv = document.getElementById("qrcode");
          qrDiv.classList.add("skeleton");
          const eventSource = new EventSource("/qr");
          eventSource.onmessage = (event) => {
            const eventData = JSON.parse(event.data);

            if (eventData.type === "qr") {
              
              if (qrDiv) {
                qrDiv.innerHTML = "";
                

              }
              var qrcode = new QRCode(document.getElementById("qrcode"), {
                text: eventData.qrCode,
                width: 300,
                height: 300,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L,
              });
            } else if (eventData.type === "ready") {
              setIsReady(true);
              qrDiv.classList.add("hidden")
            }

            console.log("Received", eventData);
            // Handle the incoming event data
          };

          return () => {
            // Cleanup when component unmounts
            eventSource.close();
          };
        }, []);
        // Handle incoming events

        return html` <div id="qrcode" ${isReady? "hidden" : ""}><p>Carregando QR Code...</p></div>
          <${BulkMessager} isReady=${isReady} />`;
      }

      render(html`<${App} />`, document.body);
    </script>
  </head>
  <body></body>
</html>
