<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>title</title>
    <script type="importmap">
      {
        "imports": {
          "preact": "https://esm.sh/preact@10.19.2",
          "preact/": "https://esm.sh/preact@10.19.2/",
          "htm/preact": "https://esm.sh/htm@3.1.1/preact?external=preact",
          "phoneNumbers": "./phoneNumbers.js"
        }
      }
    </script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      src="https://kit.fontawesome.com/b709610c08.js"
      crossorigin="anonymous"
    ></script>

    <link rel="stylesheet" href="./style.css" />
    <script type="module">
      import { render } from "preact";
      import { useReducer, useEffect, useState } from "preact/hooks";
      import { html } from "htm/preact";
      import { getFormattedNumbers } from "phoneNumbers";

      const NumberTag = ({ number, key, removeNumber }) => {
        return html`
          <div
            key=${key}
            class="numbertag shadow-md max-h-[40px] py-2 flex bg-stone-200 pl-3 pr-3  rounded-lg max-w-[200px]"
          >
            <p>${number}</p>
            <i
              class="fa-solid cursor-pointer fa-x m-auto ml-2 text-[10px]"
              onClick=${() => removeNumber(number)}
            ></i>
          </div>
        `;
      };

      function BulkMessager({ isReady, clientId }) {
        const [validatedNumbers, setValidatedNumbers] = useState([]);
        const [numbersString, setNumbersString] = useState("");
        const [messageToSend, setMessageToSend] = useState("");

        const removeNumber = (number) => {
          setValidatedNumbers((prev) => prev.filter((num) => num !== number));
        };
        const onNumbersChange = (e) => {
          setNumbersString(e.target.value);
          if (
            e.key == " " ||
            e.code == "Space" ||
            e.keyCode == 32 ||
            e.key == "Enter" ||
            e.code == "Enter" ||
            e.keyCode == 13
          ) {
            setValidatedNumbers((prev) => [
              ...prev,
              ...getFormattedNumbers(numbersString, validatedNumbers).numbers,
            ]);
            setNumbersString("");
          } else if (
            e.key === "Backspace" ||
            e.code === "Backspace" ||
            e.keyCode === 8
          ) {
            if (numbersString.length === 0) {
              setValidatedNumbers((prev) => prev.slice(0, -1));
            }
          }
        };
        useEffect(() => {
          console.log(validatedNumbers);
        });
        const onSendMessages = () => {
          fetch("/bulk-messages", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              numbers: validatedNumbers,
              message: messageToSend,
              clientId: clientId,
            }),
          }).then((response) =>
            response.json().then((data) => console.log(data))
          );
        };

        return html`
          <div
            className="flex w-[800px] m-auto p-10 flex-col ${isReady
              ? "hidden"
              : ""} items-start"
          >
            <p className="text-large text-left font-semibold">
              Disparo de mensagens em massa
            </p>
            <p className="text-left">
              Insira as informações necessárias e clique em enviar mensagens
            </p>

            <p className="text-base mt-4 font-semibold">Destinatários</p>

            <div
              className="w-full h-[200px] overflow-auto flex items-start content-start gap-2 flex-wrap mt-2 input-message rounded-t-lg p-4 border max-w-full"
            >
              ${validatedNumbers
                ? validatedNumbers.map((number, index) => {
                    return html`<${NumberTag}
                      removeNumber=${removeNumber}
                      number=${number}
                      key=${index}
                    />`;
                  })
                : null}
              <input
                type="text"
                placeholder=${validatedNumbers.length
                  ? ""
                  : "Números separados por vários números, espaço ou quebra de linha"}
                value=${numbersString}
                onkeyup=${onNumbersChange}
                className="flex-1 rounded-t-lg p-1 border-0 max-w-full"
              />
            </div>
            <textarea
              placeholder="Insira a mensagem a ser enviada"
              className="bg-[#F9F9F9] input-message w-full h-[200px] rounded-b-lg  border-t-0 p-4 border max-w-full"
            ></textarea>
            <button
              className="bg-[#1B965B] ml-auto hover:bg-blueDark text-white px-6 py-3 rounded-lg mt-4 font-semibold"
            >
              Enviar para todos
            </button>
          </div>
        `;
      }

      export function App() {
        const [count, add] = useReducer((a, b) => a + b, 0);
        const [isReady, setIsReady] = useState(false);
        const [clientId, setClientId] = useState("");

        useEffect(() => {
          const qrDiv = document.getElementById("qrcode");
          qrDiv.classList.add("skeleton");
          const eventSource = new EventSource("/qr");
          eventSource.onmessage = (event) => {
            const eventData = JSON.parse(event.data);

            if (eventData.type === "qr") {
              if (qrDiv) {
                qrDiv.innerHTML = "";
              }
              var qrcode = new QRCode(document.getElementById("qrcode"), {
                text: eventData.qrCode,
                width: 300,
                height: 300,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.L,
              });
            } else if (eventData.type === "ready") {
              setIsReady(true);
              qrDiv.classList.add("hidden");
              setClientId(eventData.id);
            }

            console.log("Received", eventData);
            // Handle the incoming event data
          };

          return () => {
            // Cleanup when component unmounts
            eventSource.close();
          };
        }, []);
        // Handle incoming events

        return html` <div id="qrcode" ${isReady ? "hidden" : ""}>
            <p>Carregando QR Code...</p>
          </div>

          <${BulkMessager} isReady=${isReady} clientId=${clientId} />`;
      }

      render(html`<${App} />`, document.body);
    </script>
  </head>
  <body></body>
</html>
